<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Time Slot Booking</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0px 0px 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      text-align: center;
    }
    .slot, .booked-slot {
      border: 1px solid #ddd;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .slot.booked, .booked-slot.booked {
      background-color: #f8d7da;
      color: #721c24;
    }
    .slot.available, .booked-slot.available {
      background-color: #d4edda;
      color: #155724;
    }
    button {
      padding: 8px 12px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button.book-btn {
      background-color: #007bff;
      color: white;
    }
    button.book-btn:hover {
      background-color: #0056b3;
    }
    .date-picker,
    .section {
      margin-bottom: 20px;
      text-align: center;
    }
    input[type="date"] {
      font-size: 16px;
      padding: 5px;
    }
    .loading {
      text-align: center;
      font-size: 18px;
      color: #555;
    }
    .queue-status,
    .booked-status {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #eef;
    }
    .action-buttons {
      text-align: center;
      margin-top: 20px;
    }
    .action-buttons button {
      margin: 0 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Time Slot Booking</h1>
    <div class="date-picker">
      <label for="slot-date">Select Date:</label>
      <input type="date" id="slot-date">
      <button id="fetch-slots">Fetch Slots</button>
    </div>
    <div id="slots-container"></div>
    
    <!-- Section for booked slots for this voter -->
    <div id="booked-slots-container" class="booked-status"></div>
    
    <!-- Action buttons -->
    <div class="action-buttons">
      <button id="view-queue-status">View Queue Status</button>
      <button id="back-dashboard">Back to Dashboard</button>
    </div>
  </div>

  <script>
    // Retrieve stored values from localStorage (make sure your login saves these)
    const voterId = localStorage.getItem("voterId");
    const phoneNumber = localStorage.getItem("phoneNumber");

    // If these are not set, you might need to redirect the user to log in again
    // if (!voterId || !phoneNumber) {
    //   alert("User details missing. Please log in.");
    //   window.location.href = "/login.html";
    // }

    // Set default date to today (YYYY-MM-DD)
    const slotDateInput = document.getElementById("slot-date");
    const today = new Date().toISOString().split("T")[0];
    slotDateInput.value = today;

    /***********************************
     * FETCH AVAILABLE TIME SLOTS
     ***********************************/
    async function fetchSlots(date) {
      const slotsContainer = document.getElementById("slots-container");
      slotsContainer.innerHTML = `<p class="loading">Loading slots...</p>`;
      try {
        const token = localStorage.getItem("token"); // Get JWT token
        // Use backticks for your URL and Bearer token
        const response = await fetch(`/api/timeslots/available?date=${date}`, {
          headers: {
            Authorization: `Bearer ${token}`
          }
        });
        if (!response.ok) throw new Error("Failed to fetch time slots.");
        const slots = await response.json();
        displaySlots(slots);
      } catch (error) {
        console.error("Error fetching slots:", error);
        slotsContainer.innerHTML = "<p style='color: red;'>Error fetching time slots.</p>";
      }
    }

    /***********************************
     * DISPLAY AVAILABLE SLOTS
     ***********************************/
    function displaySlots(slots) {
      const slotsContainer = document.getElementById("slots-container");
      slotsContainer.innerHTML = "";
      if (!slots.length) {
        slotsContainer.innerHTML = "<p>No slots available for this date.</p>";
        return;
      }
      slots.forEach(slot => {
        const slotDiv = document.createElement("div");
        slotDiv.classList.add("slot");
        // Mark as "booked" if capacity is reached
        slotDiv.classList.add(slot.bookedVoters.length >= slot.maxCapacity ? "booked" : "available");

        // Build the HTML for each slot
        slotDiv.innerHTML = `
          <div>
            <strong>${slot.startTime} - ${slot.endTime}</strong><br>
            Booked: ${slot.bookedVoters.length} / ${slot.maxCapacity}
          </div>
          <div>
            <button class="book-btn" data-slot-id="${slot._id}" ${
              slot.bookedVoters.length >= slot.maxCapacity ? "disabled" : ""
            }>
              ${slot.bookedVoters.length >= slot.maxCapacity ? "Slot Full" : "Book Slot"}
            </button>
          </div>
        `;
        slotsContainer.appendChild(slotDiv);
      });

      // Attach event listeners to all non-disabled "Book Slot" buttons
      document.querySelectorAll(".book-btn:not([disabled])").forEach(button => {
        button.addEventListener("click", bookSlot);
      });
    }

    /***********************************
     * BOOK A TIME SLOT
     ***********************************/
    async function bookSlot(event) {
      const button = event.target;
      const slotId = button.getAttribute("data-slot-id");
      button.disabled = true;
      button.innerText = "Booking...";

      try {
        const token = localStorage.getItem("token"); // Get JWT token
        const response = await fetch("/api/timeslots/book", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ slotId })
        });

        const result = await response.json();
        if (response.ok) {
          alert(result.message);
          // Refresh available slots
          fetchSlots(slotDateInput.value);
          // Refresh booked slots
          fetchBookedSlots();
        } else {
          alert(result.error || "Booking failed.");
          button.disabled = false;
          button.innerText = "Book Slot";
        }
      } catch (error) {
        console.error("Error booking slot:", error);
        alert("Booking failed. Please try again.");
        button.disabled = false;
        button.innerText = "Book Slot";
      }
    }

    /***********************************
     * FETCH BOOKED SLOTS FOR THE VOTER
     ***********************************/
    async function fetchBookedSlots() {
      const bookedContainer = document.getElementById("booked-slots-container");
      bookedContainer.innerHTML = `<p class="loading">Loading booked slots...</p>`;
      try {
        const token = localStorage.getItem("token");
        // The backend returns an array, either empty or [oneSlot]
        const response = await fetch(`/api/timeslots/booked`, {
          headers: { Authorization: `Bearer ${token}` }
        });
        if (!response.ok) throw new Error("Failed to fetch booked slots.");
        const bookedSlots = await response.json();

        if (!bookedSlots.length) {
          bookedContainer.innerHTML = "<p>No booked slots found.</p>";
          return;
        }

        // Render booked slots (in this case, typically just one)
        bookedContainer.innerHTML = bookedSlots
          .map(slot => {
            return `
              <div class="booked-slot booked">
                <div>
                  <strong>${slot.date}</strong>: ${slot.startTime} - ${slot.endTime}<br>
                  <span id="slot-id-${slot._id}">Slot ID: ${slot._id}</span>
                </div>
                <button onclick="copySlotID('${slot._id}')">Copy Slot ID</button>
              </div>
            `;
          })
          .join("");
      } catch (error) {
        console.error("Error fetching booked slots:", error);
        bookedContainer.innerHTML = "<p style='color: red;'>Error loading booked slots.</p>";
      }
    }

    /***********************************
     * COPY SLOT ID FUNCTION
     ***********************************/
    function copySlotID(slotId) {
      const slotText = document
        .getElementById(`slot-id-${slotId}`)
        .innerText.split(": ")[1];
      navigator.clipboard
        .writeText(slotText)
        .then(() => alert(`Slot ID copied: ${slotText}`))
        .catch(err => console.error("Failed to copy:", err));
    }

    /***********************************
     * NAVIGATE TO QUEUE STATUS PAGE
     ***********************************/
    document.getElementById("view-queue-status").addEventListener("click", () => {
      window.location.href = "/queue-status.html";
    });

    /***********************************
     * INITIALIZE EVENT LISTENERS ON LOAD
     ***********************************/
    document.addEventListener("DOMContentLoaded", () => {
      // Fetch available slots for "today"
      fetchSlots(today);
      // Fetch booked slot(s) on page load so it doesn't disappear after refresh
      fetchBookedSlots();

      document.getElementById("fetch-slots").addEventListener("click", () => {
        fetchSlots(slotDateInput.value);
      });

      document.getElementById("back-dashboard").addEventListener("click", () => {
        window.location.href = "/dashboard.html";
      });
    });
  </script>
</body>
</html>
