<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Digital Token</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.js"></script>
</head>
<body>
    <h2>Scan Digital Token QR Code</h2>
    <video id="camera-preview" width="300" height="300" autoplay></video>
    <canvas id="qr-canvas" hidden></canvas>
    <p id="result"></p>

    <script>
        const video = document.getElementById("camera-preview");
        const canvas = document.getElementById("qr-canvas");
        const ctx = canvas.getContext("2d");

        async function startScanner() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                scanQRCode();
            } catch (error) {
                alert("Camera access denied.");
            }
        }

        function scanQRCode() {
            const interval = setInterval(() => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);

                if (code) {
                    clearInterval(interval);
                    verifyToken(code.data);
                }
            }, 1000);
        }

        async function verifyToken(digitalToken) {
            const response = await fetch("http://localhost:5000/api/digital-token/verify", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ digitalToken })
            });

            const data = await response.json();
            document.getElementById("result").innerText = data.message || "Invalid Token";
        }

        startScanner();
    </script>
</body>
</html>
