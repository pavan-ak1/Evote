<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Election Commission of India</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <style>
        body {
            background-color: whitesmoke;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .sidebar {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 48px 0 0;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, 0.1);
    background-color: #0a2540;
    color: white;
}

.sidebar-sticky {
    position: sticky;
    top: 0;
    height: calc(100vh - 48px);
    padding-top: 0.5rem;
    overflow-x: hidden;
    overflow-y: auto;
}

.nav-link {
    font-weight: 500;
    color: #ffffff;
    padding: 0.75rem 1rem;
    border-left: 4px solid transparent;
    transition: all 0.3s ease-in-out;
}

.nav-link.active {
    color: #0a2540;
    border-left: 4px solid #4f8ccf;
    background-color: #e3f2fd;
}

.nav-link:hover {
    color: #f8f9fa;
    border-left: 4px solid #66a3d2;
    background-color: rgba(255, 255, 255, 0.1);
}

.navbar-brand {
    font-size: 1.2rem;
    padding: 0.75rem;
    background-color: #14467c;
    color: white;
    text-align: center;
}

.main-content {
    margin-left: 250px;
    padding: 20px;
    background-color: #f5f7fa;
}

.dashboard-card {
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    padding: 20px;
    margin-bottom: 20px;
    background-color: #ffffff;
    border-left: 5px solid #4f8ccf;
}

.dashboard-card h5 {
    margin-bottom: 15px;
    color: #0a2540;
    font-weight: 600;
}

.stats-card {
    background: linear-gradient(to right, #3b78a6, #0a2540);
    color: white;
    padding: 15px;
    border-radius: 10px;
    margin-bottom: 20px;
}

.stats-icon {
    font-size: 24px;
    margin-right: 10px;
}

.stats-number {
    font-size: 28px;
    font-weight: 700;
}

.stats-label {
    font-size: 14px;
    opacity: 0.9;
}

.table th {
    font-weight: 600;
    color: #0a2540;
}

.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.qr-scanner {
    width: 100%;
    max-width: 500px;
    margin: 0 auto;
}

#qr-reader {
    width: 100%;
    border: 1px solid #4f8ccf;
    border-radius: 10px;
}

#qr-reader img {
    width: 100%;
}

.face-verification-container {
    max-width: 600px;
    margin: 0 auto;
}

#videoElement {
    width: 100%;
    border-radius: 10px;
    border: 2px solid #4f8ccf;
}

.verify-btn {
    background: linear-gradient(to right, #3b78a6, #0a2540);
    border: none;
    color: white;
    width: 100%;
    padding: 10px;
    border-radius: 5px;
    font-weight: 600;
    margin-top: 15px;
    transition: 0.3s;
}

.verify-btn:hover {
    background: linear-gradient(to right, #66a3d2, #14467c);
}

.logout-btn {
    background-color: #dc3545;
    color: white;
    font-weight: 600;
}

</style>
</head>
<body>
    <nav class="navbar navbar-dark sticky-top bg-dark flex-md-nowrap p-0 shadow">
        <a class="navbar-brand col-md-3 col-lg-2 me-0 px-3" href="#">Election Commission</a>
        <button class="navbar-toggler position-absolute d-md-none collapsed" type="button" data-toggle="collapse" data-target="#sidebarMenu" aria-controls="sidebarMenu" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="w-100"></div>
        <ul class="navbar-nav px-3">
            <li class="nav-item text-nowrap">
                <button id="logoutBtn" class="btn btn-sm logout-btn" class="bg-red-600 text-white py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300">Sign out</button>
            </li>
        </ul>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                <div class="position-sticky sidebar-sticky">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="dashboard">
                                <i class="bi bi-speedometer2 me-2"></i>
                                Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="voters">
                                <i class="bi bi-people me-2"></i>
                                Voters
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="qr-verification">
                                <i class="bi bi-qr-code-scan me-2"></i>
                                QR Verification
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="face-verification">
                                <i class="bi bi-person-badge me-2"></i>
                                Face Verification
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="ai-assistant">
                                <i class="bi bi-robot me-2"></i>
                                AI Assistant
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
                <!-- Dashboard Section -->
                <div class="content-section active" id="dashboard-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Dashboard</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="d-flex align-items-center">
                                    <div class="stats-icon">
                                        <i class="bi bi-person"></i>
                                    </div>
                                    <div>
                                        <div class="stats-number" id="totalVoters">0</div>
                                        <div class="stats-label">Total Voters</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="stats-card">
                                <div class="d-flex align-items-center">
                                    <div class="stats-icon">
                                        <i class="bi bi-check-circle"></i>
                                    </div>
                                    <div>
                                        <div class="stats-number" id="verifiedVoters">0</div>
                                        <div class="stats-label">Verified Voters</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card mt-4">
                        <h5>Recent Voter Registrations</h5>
                        <div class="table-responsive">
                            <table class="table table-striped" id="recentVotersTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Voter ID</th>
                                        <th>Phone</th>
                                        <th>Time Slot</th>
                                    </tr>
                                </thead>
                                <tbody id="recentVotersList">
                                    <!-- Recent voters will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Voters Section -->
                <div class="content-section" id="voters-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Voters Management</h1>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Voter ID</th>
                                        <th>Email</th>
                                        <th>Phone</th>
                                    </tr>
                                </thead>
                                <tbody id="votersTableBody">
                                    <tr>
                                        <td colspan="4" class="text-center">Loading voters data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- QR Verification Section -->
                <div class="content-section" id="qr-verification-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">QR Token Verification</h1>
                    </div>
                    <div class="row">
                        <div class="col-md-8 mb-4">
                            <div class="dashboard-card">
                                <h5 class="card-title">Scan QR Code</h5>
                                <div class="qr-scanner">
                                    <div id="qr-reader"></div>
                                </div>
                                <div class="mt-4">
                                    <p class="text-center">or</p>
                                    <div class="mb-3">
                                        <label for="qrManualInput" class="form-label">Enter QR Token Data Manually</label>
                                        <textarea id="qrManualInput" class="form-control" rows="3" placeholder="Paste token data here"></textarea>
                                    </div>
                                    <button id="verifyManualQr" class="btn btn-primary">Verify Token</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="dashboard-card">
                                <div id="qrVerificationResult" class="d-none">
                                    <h5 class="card-title">Voter Information</h5>
                                    <div id="verificationStatus" class="alert alert-info mt-3">
                                        No token scanned yet.
                                    </div>
                                    <div class="voter-info mt-4">
                                        <h6>Voter Details</h6>
                                        <table class="table table-sm">
                                            <tr>
                                                <th>Name:</th>
                                                <td id="voterName">N/A</td>
                                            </tr>
                                            <tr>
                                                <th>Voter ID:</th>
                                                <td id="voterIdDisplay">N/A</td>
                                            </tr>
                                            <tr>
                                                <th>Phone:</th>
                                                <td id="voterPhone">N/A</td>
                                            </tr>
                                        </table>
                                        
                                        <!-- Add QR verification buttons -->
                                        <div class="mt-3">
                                            <button id="allowQrBtn" class="btn btn-success me-2">Allow Voting</button>
                                            <button id="denyQrBtn" class="btn btn-danger">Deny Voting</button>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <button id="proceedToFaceVerification" class="btn btn-success w-100">
                                                <i class="bi bi-camera"></i> Proceed to Face Verification
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Face Verification Section -->
                <div class="content-section" id="face-verification-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Face Verification</h1>
                    </div>
                    <div class="face-verification-container">
                        <div class="dashboard-card">
                            <h5 class="card-title">Capture Voter's Face</h5>
                            <p>Please capture a clear photo of the voter's face for verification.</p>
                            
                            <div class="mt-3">
                                <video id="videoElement" width="100%" height="auto" autoplay></video>
                                <canvas id="canvasElement" class="d-none"></canvas>
                            </div>
                            
                            <div class="mt-3">
                                <button id="captureBtn" class="btn btn-primary">Capture Image</button>
                                <button id="submitVerificationBtn" class="btn btn-success">Verify Face</button>
                                <button id="updateFaceBtn" class="btn btn-warning">Update Face Photo</button>
                            </div>
                            
                            <div id="verificationResult" class="mt-4 d-none">
                                <h5>Verification Result</h5>
                                <div id="faceVerificationStatus" class="alert alert-info mb-3">
                                    Processing verification...
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Captured Image</h6>
                                        <img id="capturedImage" class="img-fluid rounded" alt="Captured face" />
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Registered Image</h6>
                                        <img id="registeredImage" class="img-fluid rounded" alt="Registered face" />
                                        <div class="mt-2">
                                            <small class="text-muted">Last updated: <span id="lastUpdateTime">N/A</span></small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-4">
                                    <div class="col-12">
                                        <h6>Match Details</h6>
                                        <p>Match Percentage: <span id="matchPercentage">0</span>%</p>
                                        <div class="progress mb-3">
                                            <div id="matchProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                        
                                        <div id="verificationActions" class="mt-4 text-center" style="display: none;">
                                            <button id="continueToVotingBtn" class="btn btn-success">
                                                <i class="bi bi-check-circle"></i> Continue to Voting
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Assistant Section -->
                <div class="content-section" id="ai-assistant-section">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">AI Assistant</h1>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="chat-container" style="height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 15px;">
                            <div id="chat-messages" class="mb-3"></div>
                        </div>
                        
                        <div class="input-group">
                            <input type="text" id="user-input" class="form-control" placeholder="Ask a question...">
                            <button class="btn btn-primary" id="send-message">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script>
        // Check if user is logged in and is admin
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('adminToken');
            const isAdmin = localStorage.getItem('isAdmin');
            
            console.log('Admin token:', token);
            console.log('Is admin flag:', isAdmin);
            
            if (!token || isAdmin !== 'true') {
                console.log('Not authenticated as admin, redirecting to login');
                window.location.href = '/index.html';
                return;
            }
            
            // Initialize components
            initializeDashboard();
            initializeNavigation();
            initializeQRScanner();
            initializeFaceVerification();
            initializeAIAssistant();
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                localStorage.removeItem('adminToken');
                localStorage.removeItem('isAdmin');
                localStorage.removeItem('userId');
                window.location.href = '/index.html';
            });
        });
        
        // Navigation
        function initializeNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links and sections
                    navLinks.forEach(l => l.classList.remove('active'));
                    sections.forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link and corresponding section
                    this.classList.add('active');
                    const sectionId = this.getAttribute('data-section') + '-section';
                    document.getElementById(sectionId).classList.add('active');
                    
                    // Load section data if needed
                    if (sectionId === 'voters-section') {
                        loadVoters();
                    }
                });
            });
        }
        
        // Dashboard initialization
        function initializeDashboard() {
            fetchStats();
            fetchRecentVoters();
        }
        
        async function fetchStats() {
            try {
                const token = localStorage.getItem('adminToken');
                
                // Fetch total voters
                const votersResponse = await fetch('/api/admin/voters', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (votersResponse.ok) {
                    const voters = await votersResponse.json();
                    document.getElementById('totalVoters').textContent = voters.length;
                    
                    // Count verified voters (either by face or token)
                    const verifiedVoters = voters.filter(voter => 
                        voter.faceVerifiedAt || voter.tokenVerifiedAt || 
                        (voter.digitalToken && voter.digitalToken.isUsed)
                    ).length;
                    
                    document.getElementById('verifiedVoters').textContent = verifiedVoters;
                }
            } catch (error) {
                console.error('Error fetching stats:', error);
            }
        }
        
        // Fetch recent voters for dashboard
        async function fetchRecentVoters() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/voters', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const voters = await response.json();
                    const recentVotersList = document.getElementById('recentVotersList');
                    recentVotersList.innerHTML = '';
                    
                    // Show only 5 most recent voters
                    const recentVoters = voters.slice(0, 5);
                    
                    recentVoters.forEach((voter, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${index + 1}</td>
                            <td>${voter.name || 'N/A'}</td>
                            <td>${voter.voterId || 'N/A'}</td>
                            <td>${voter.phoneNumber || 'N/A'}</td>
                            <td>${voter.timeSlot ? formatDateTime(voter.timeSlot.date, voter.timeSlot.startTime) : 'Not Booked'}</td>
                        `;
                        recentVotersList.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching recent voters:', error);
            }
        }
        
        // Load voters
        async function loadVoters() {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch('/api/admin/voters', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const voters = await response.json();
                    const votersTableBody = document.getElementById('votersTableBody');
                    votersTableBody.innerHTML = '';
                    
                    if (voters.length === 0) {
                        votersTableBody.innerHTML = '<tr><td colspan="4" class="text-center">No voters found</td></tr>';
                        return;
                    }
                    
                    voters.forEach(voter => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${voter.name || 'N/A'}</td>
                            <td>${voter.voterId || voter.id || 'N/A'}</td>
                            <td>${voter.email || 'N/A'}</td>
                            <td>${voter.phoneNumber || 'N/A'}</td>
                        `;
                        votersTableBody.appendChild(row);
                    });
                    
                    // Add event listeners for view buttons
                    document.querySelectorAll('.view-voter').forEach(button => {
                        button.addEventListener('click', function() {
                            const voterId = this.getAttribute('data-voter-id');
                            viewVoterDetails(voterId);
                        });
                    });
                } else {
                    document.getElementById('votersTableBody').innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center text-danger">Error loading voters</td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading voters:', error);
                document.getElementById('votersTableBody').innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-danger">Error loading voters</td>
                    </tr>
                `;
            }
        }
        
        // View voter details
        async function viewVoterDetails(voterId) {
            try {
                const token = localStorage.getItem('adminToken');
                const response = await fetch(`/api/admin/voters/${voterId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const voter = await response.json();
                    
                    // Determine verification status
                    let verificationStatus = [];
                    if (voter.faceVerifiedAt) {
                        verificationStatus.push("Face Verified: " + new Date(voter.faceVerifiedAt).toLocaleString());
                    }
                    if (voter.tokenVerifiedAt) {
                        verificationStatus.push("Token Verified: " + new Date(voter.tokenVerifiedAt).toLocaleString());
                    }
                    if (verificationStatus.length === 0) {
                        verificationStatus.push("Not verified");
                    }
                    
                    // Show details in alert
                    alert(`Voter Details:
Name: ${voter.name || 'N/A'}
Voter ID: ${voter.voterId || voter._id || 'N/A'}
Email: ${voter.email || 'N/A'}
Phone: ${voter.phoneNumber || 'N/A'}
Verification Status: ${verificationStatus.join(', ')}
${voter.timeSlot ? `Time Slot: ${formatDateTime(voter.timeSlot.date, voter.timeSlot.startTime)}` : 'No Time Slot Booked'}`);
                }
            } catch (error) {
                console.error('Error fetching voter details:', error);
            }
        }
        
        // QR Scanner initialization
        function initializeQRScanner() {
            let html5QrCode = null;
            const qrConfig = { 
                fps: 10,
                qrbox: { width: 250, height: 250 },
                aspectRatio: 1.0,
                showTorchButtonIfSupported: true,
                showZoomSliderIfSupported: true,
                supportedScanTypes: [
                    Html5QrcodeScanType.SCAN_TYPE_CAMERA,
                    Html5QrcodeScanType.SCAN_TYPE_FILE
                ]
            };
            
            // Start scanning
            function startScanner() {
                try {
                    // Create a new instance if not created or previously stopped
                    if (!html5QrCode) {
                        html5QrCode = new Html5Qrcode("qr-reader");
                    }
                    
                    // Only start if not already scanning
                    if (!html5QrCode.isScanning) {
                        // Force using the front camera
                        html5QrCode.start(
                            { facingMode: "user" },
                            qrConfig,
                            onScanSuccess,
                            onScanFailure
                        ).catch(err => {
                            console.error('QR Scanner error:', err);
                            alert('Error accessing camera. Please make sure your laptop camera is available and you have granted camera permissions.');
                        });
                    }
                } catch (err) {
                    console.error('Error starting QR scanner:', err);
                }
            }
            
            // QR code successfully scanned
            function onScanSuccess(decodedText) {
                // Stop scanner
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().then(() => {
                        console.log('Scanner stopped');
                    }).catch(err => {
                        console.error('Error stopping scanner:', err);
                    });
                }
                
                console.log('QR Code scanned:', decodedText);
                verifyQRToken(decodedText);
            }
            
            // QR scan failure
            function onScanFailure(error) {
                // Only log actual errors, not normal scanning attempts
                if (error && !error.toString().includes('No MultiFormat Readers')) {
                    console.warn(`QR scan error: ${error}`);
                }
            }
            
            // Start scanner when QR verification tab is clicked
            document.querySelector('a[data-section="qr-verification"]').addEventListener('click', function() {
                setTimeout(startScanner, 500);
            });
            
            // Manual QR verification
            document.getElementById('verifyManualQr').addEventListener('click', function() {
                const token = document.getElementById('qrManualInput').value.trim();
                if (token) {
                    verifyQRToken(token);
                }
            });
        }
        
        // Verify QR token
        async function verifyQRToken(tokenData) {
            try {
                console.log('Verifying QR token:', tokenData);
                
                // Show the verification result container and set processing status
                document.getElementById('qrVerificationResult').classList.remove('d-none');
                const verificationStatus = document.getElementById('verificationStatus');
                verificationStatus.textContent = "Processing token...";
                verificationStatus.className = "alert mt-3 alert-info";
                
                const token = localStorage.getItem('adminToken');
                console.log('Using admin token for verification:', token ? 'Token exists' : 'No token found');
                
                const response = await fetch('/api/admin/read-qr', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ tokenData })
                });
                
                console.log('QR verification response status:', response.status);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('QR verification error:', errorData);
                    
                    verificationStatus.className = 'alert mt-3 alert-danger';
                    verificationStatus.textContent = errorData.error || 'Invalid QR Token';
                    return null;
                }
                
                const data = await response.json();
                console.log('QR verification response data:', JSON.stringify(data, null, 2));
                
                if (data && data.user) {
                    // Ensure voter info fields are populated
                    document.getElementById('voterName').textContent = data.user.name || 'N/A';
                    document.getElementById('voterIdDisplay').textContent = data.user.voterId || data.user._id || data.user.id || 'N/A';
                    document.getElementById('voterPhone').textContent = data.user.phoneNumber || 'N/A';
                    
                    // Show success status
                    verificationStatus.className = 'alert mt-3 alert-success';
                    verificationStatus.textContent = 'QR Token verified successfully!';
                    
                    // Store voter ID for face verification
                    if (data.user._id || data.user.id) {
                        const voterId = data.user._id || data.user.id;
                        localStorage.setItem('currentVoterId', voterId);
                        console.log('Set current voter ID:', voterId);
                    }
                } else {
                    console.error('Invalid data format from server:', data);
                    
                    // Clear voter information fields
                    document.getElementById('voterName').textContent = 'N/A';
                    document.getElementById('voterIdDisplay').textContent = 'N/A';
                    document.getElementById('voterPhone').textContent = 'N/A';
                    
                    // Show error status
                    verificationStatus.className = 'alert mt-3 alert-danger';
                    verificationStatus.textContent = 'Invalid data received from server';
                }
                
                return data;
            } catch (error) {
                console.error('Error verifying QR token:', error);
                
                const verificationStatus = document.getElementById('verificationStatus');
                verificationStatus.className = 'alert mt-3 alert-danger';
                verificationStatus.textContent = 'Error processing QR token. Please try again.';
                
                return null;
            }
        }
        
        // Reset face verification
        function resetFaceVerification() {
            // Clear captured image
            const capturedImage = document.getElementById('capturedImage');
            if (capturedImage) {
                capturedImage.src = '';
            }
            
            // Hide verification result
            const verificationResult = document.getElementById('verificationResult');
            if (verificationResult) {
                verificationResult.classList.add('d-none');
            }
            
            // Reset status message
            const faceVerificationStatus = document.getElementById('faceVerificationStatus');
            if (faceVerificationStatus) {
                faceVerificationStatus.textContent = "Processing face recognition...";
                faceVerificationStatus.className = "alert alert-info";
            }
            
            // Reset progress bar
            const matchPercentage = document.getElementById('matchPercentage');
            const matchProgress = document.getElementById('matchProgress');
            if (matchPercentage) matchPercentage.textContent = "0";
            if (matchProgress) {
                matchProgress.style.width = "0%";
                matchProgress.setAttribute('aria-valuenow', "0");
            }
            
            // Clear voter ID from dataset
            if (verificationResult) {
                verificationResult.dataset.voterId = '';
            }
        }
        
        // Face verification
        function initializeFaceVerification() {
            const videoElement = document.getElementById('videoElement');
            const canvasElement = document.getElementById('canvasElement');
            const captureBtn = document.getElementById('captureBtn');
            const submitVerificationBtn = document.getElementById('submitVerificationBtn');
            const verificationResult = document.getElementById('verificationResult');
            const faceVerificationStatus = document.getElementById('faceVerificationStatus');
            const matchPercentage = document.getElementById('matchPercentage');
            const matchProgress = document.getElementById('matchProgress');
            const registeredImage = document.getElementById('registeredImage');
            let capturedImage = null;
            
            // Start camera when face verification tab is clicked
            document.querySelector('a[data-section="face-verification"]').addEventListener('click', startCamera);
            
            // Start camera
            function startCamera() {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: "user"
                        } 
                    })
                    .then(function(stream) {
                        videoElement.srcObject = stream;
                    })
                    .catch(function(error) {
                        console.error('Error accessing camera:', error);
                        faceVerificationStatus.textContent = 'Error accessing camera. Please check permissions.';
                        faceVerificationStatus.className = 'alert alert-danger';
                    });
                } else {
                    faceVerificationStatus.textContent = 'Camera access not supported in this browser.';
                    faceVerificationStatus.className = 'alert alert-danger';
                }
            }
            
            // Capture image
            captureBtn.addEventListener('click', async function() {
                const context = canvasElement.getContext('2d');
                canvasElement.width = videoElement.videoWidth;
                canvasElement.height = videoElement.videoHeight;
                context.drawImage(videoElement, 0, 0, canvasElement.width, canvasElement.height);
                
                capturedImage = canvasElement.toDataURL('image/jpeg');
                document.getElementById('capturedImage').src = capturedImage;
                
                // Show verification result section
                verificationResult.classList.remove('d-none');
                faceVerificationStatus.textContent = 'Image captured. Click "Verify Face" to proceed.';
                faceVerificationStatus.className = 'alert alert-info';

                // Fetch and display registered face image
                const voterId = localStorage.getItem('currentVoterId');
                if (voterId) {
                    try {
                        const token = localStorage.getItem('adminToken');
                        const response = await fetch(`/api/admin/voters/${voterId}`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        if (response.ok) {
                            const data = await response.json();
                            
                            if (data.success && data.user) {
                                // Check for registered face image
                                if (data.user.faceImageUrl || (data.user.faceEmbedding && data.user.faceEmbedding.length > 0)) {
                                    // Display registered image - prioritize faceImageUrl if available
                                    const registeredFaceImage = data.user.faceImageUrl || data.user.faceEmbedding[0];
                                    registeredImage.src = registeredFaceImage;
                                    registeredImage.style.display = 'block';
                                    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString();
                                } else {
                                    faceVerificationStatus.textContent = 'No registered face found for this voter. Please register face first.';
                                    faceVerificationStatus.className = 'alert alert-warning';
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Error fetching registered face:', error);
                        faceVerificationStatus.textContent = 'Error fetching registered face image.';
                        faceVerificationStatus.className = 'alert alert-danger';
                    }
                } else {
                    faceVerificationStatus.textContent = 'No voter ID found. Please verify QR code first.';
                    faceVerificationStatus.className = 'alert alert-warning';
                }
            });
            
            // Submit verification
            submitVerificationBtn.addEventListener('click', async function() {
                if (!capturedImage) {
                    faceVerificationStatus.textContent = 'Please capture an image first.';
                    faceVerificationStatus.className = 'alert alert-warning';
                    return;
                }
                
                const voterId = localStorage.getItem('currentVoterId');
                if (!voterId) {
                    faceVerificationStatus.textContent = 'No voter ID found. Please verify QR code first.';
                    faceVerificationStatus.className = 'alert alert-danger';
                    return;
                }
                
                try {
                    faceVerificationStatus.textContent = 'Verifying face...';
                    faceVerificationStatus.className = 'alert alert-info';
                    
                    // Get voter's registered face from backend
                    const token = localStorage.getItem('adminToken');
                    const response = await fetch(`/api/admin/voters/${voterId}`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch voter data');
                    }
                    
                    const data = await response.json();
                    
                    if (!data.success || !data.user) {
                        throw new Error('Failed to fetch voter data');
                    }

                    // Check for registered face image
                    if (!data.user.faceImageUrl && (!data.user.faceEmbedding || data.user.faceEmbedding.length === 0)) {
                        throw new Error('No registered face found for this voter');
                    }

                    // Display registered image - prioritize faceImageUrl if available
                    const registeredFaceImage = data.user.faceImageUrl || data.user.faceEmbedding[0];
                    if (!registeredFaceImage) {
                        throw new Error('No valid face image found');
                    }

                    // Display the registered face image
                    registeredImage.src = registeredFaceImage;
                    registeredImage.style.display = 'block';
                    
                    // Verify face
                    const verificationResponse = await fetch('/api/admin/verify-face', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            image1: capturedImage,
                            userId: voterId
                        })
                    });
                    
                    const verificationData = await verificationResponse.json();
                    console.log('Verification response:', verificationData);
                    
                    if (!verificationResponse.ok) {
                        // Handle 401 specifically
                        if (verificationResponse.status === 401) {
                            if (verificationData.matchPercentage >= 70) {
                                faceVerificationStatus.textContent = `Face verification successful! Match percentage: ${verificationData.matchPercentage.toFixed(2)}%`;
                                faceVerificationStatus.className = 'alert alert-success';
                                
                                // Update match percentage display
                                const matchPercentageElement = document.getElementById('matchPercentage');
                                const matchProgressElement = document.getElementById('matchProgress');
                                const verificationActions = document.getElementById('verificationActions');
                                
                                if (matchPercentageElement && matchProgressElement) {
                                    matchPercentageElement.textContent = verificationData.matchPercentage.toFixed(2);
                                    matchProgressElement.style.width = `${verificationData.matchPercentage}%`;
                                    matchProgressElement.setAttribute('aria-valuenow', verificationData.matchPercentage);
                                    
                                    // Update progress bar color based on match percentage
                                    if (verificationData.matchPercentage >= 75) {
                                        matchProgressElement.className = 'progress-bar bg-success';
                                    } else if (verificationData.matchPercentage >= 60) {
                                        matchProgressElement.className = 'progress-bar bg-warning';
                                    } else {
                                        matchProgressElement.className = 'progress-bar bg-danger';
                                    }
                                }

                                // Show continue to voting button
                                if (verificationActions) {
                                    verificationActions.style.display = 'block';
                                }
                                
                                // Update voter status
                                try {
                                    const updateResponse = await fetch(`/api/admin/voters/${voterId}/status`, {
                                        method: 'PUT',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Authorization': `Bearer ${token}`
                                        },
                                        body: JSON.stringify({
                                            faceVerifiedAt: new Date().toISOString()
                                        })
                                    });

                                    if (!updateResponse.ok) {
                                        throw new Error('Failed to update voter status');
                                    }

                                    const updateData = await updateResponse.json();
                                    console.log('Voter status updated:', updateData);
                                } catch (updateError) {
                                    console.error('Error updating voter status:', updateError);
                                }
                            } else {
                                faceVerificationStatus.textContent = `Face verification failed. Match percentage: ${verificationData.matchPercentage.toFixed(2)}%`;
                                faceVerificationStatus.className = 'alert alert-danger';
                                
                                // Hide continue to voting button
                                const verificationActions = document.getElementById('verificationActions');
                                if (verificationActions) {
                                    verificationActions.style.display = 'none';
                                }
                            }
                        } else {
                            // Handle other errors
                            faceVerificationStatus.textContent = verificationData.error || 'Face verification failed';
                            faceVerificationStatus.className = 'alert alert-danger';
                            
                            // Hide continue to voting button
                            const verificationActions = document.getElementById('verificationActions');
                            if (verificationActions) {
                                verificationActions.style.display = 'none';
                            }
                        }
                    } else if (!verificationData.success) {
                        // Handle verification failure
                        faceVerificationStatus.textContent = verificationData.error || 'Face verification failed';
                        faceVerificationStatus.className = 'alert alert-danger';
                        
                        // Hide continue to voting button
                        const verificationActions = document.getElementById('verificationActions');
                        if (verificationActions) {
                            verificationActions.style.display = 'none';
                        }
                    } else {
                        // Handle successful verification
                        faceVerificationStatus.textContent = `Face verification successful! Match percentage: ${verificationData.matchPercentage.toFixed(2)}%`;
                        faceVerificationStatus.className = 'alert alert-success';
                        
                        // Update match percentage display
                        const matchPercentageElement = document.getElementById('matchPercentage');
                        const matchProgressElement = document.getElementById('matchProgress');
                        const verificationActions = document.getElementById('verificationActions');
                        
                        if (matchPercentageElement && matchProgressElement) {
                            matchPercentageElement.textContent = verificationData.matchPercentage.toFixed(2);
                            matchProgressElement.style.width = `${verificationData.matchPercentage}%`;
                            matchProgressElement.setAttribute('aria-valuenow', verificationData.matchPercentage);
                            
                            // Update progress bar color based on match percentage
                            if (verificationData.matchPercentage >= 75) {
                                matchProgressElement.className = 'progress-bar bg-success';
                            } else if (verificationData.matchPercentage >= 60) {
                                matchProgressElement.className = 'progress-bar bg-warning';
                            } else {
                                matchProgressElement.className = 'progress-bar bg-danger';
                            }
                        }

                        // Show continue to voting button
                        if (verificationActions) {
                            verificationActions.style.display = 'block';
                        }
                        
                        // Update voter status
                        try {
                            const updateResponse = await fetch(`/api/admin/voters/${voterId}/status`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    faceVerifiedAt: new Date().toISOString()
                                })
                            });

                            if (!updateResponse.ok) {
                                throw new Error('Failed to update voter status');
                            }

                            const updateData = await updateResponse.json();
                            console.log('Voter status updated:', updateData);
                        } catch (updateError) {
                            console.error('Error updating voter status:', updateError);
                        }
                    }
                } catch (error) {
                    console.error('Face verification error:', error);
                    faceVerificationStatus.textContent = `Error: ${error.message}`;
                    faceVerificationStatus.className = 'alert alert-danger';
                }
            });
            
            // Handle continue to voting button
            document.getElementById('continueToVotingBtn').addEventListener('click', function() {
                const voterId = localStorage.getItem('currentVoterId');
                if (voterId) {
                    // Update voter status to allowed
                    fetch(`/api/voters/${voterId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'allowed'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Voter verified successfully! Please proceed to the voting booth.');
                            resetFaceVerification();
                        } else {
                            alert('Error updating voter status.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error updating voter status.');
                    });
                }
            });
            
            // Add event listener for update face button
            document.getElementById('updateFaceBtn').addEventListener('click', async function() {
                if (!capturedImage) {
                    faceVerificationStatus.textContent = 'Please capture an image first.';
                    faceVerificationStatus.className = 'alert alert-warning';
                    return;
                }
                
                const voterId = localStorage.getItem('currentVoterId');
                if (!voterId) {
                    faceVerificationStatus.textContent = 'No voter ID found. Please verify QR code first.';
                    faceVerificationStatus.className = 'alert alert-danger';
                    return;
                }
                
                try {
                    faceVerificationStatus.textContent = 'Updating face photo...';
                    faceVerificationStatus.className = 'alert alert-info';
                    
                    const token = localStorage.getItem('adminToken');
                    const response = await fetch('/api/admin/register-face', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            image: capturedImage,
                            userId: voterId
                        })
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to update face photo');
                    }
                    
                    const data = await response.json();
                    
                    // Update the registered image display
                    document.getElementById('registeredImage').src = data.faceImageUrl;
                    document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString();
                    
                    faceVerificationStatus.textContent = 'Face photo updated successfully!';
                    faceVerificationStatus.className = 'alert alert-success';
                    
                    // Reset verification status
                    user.faceVerifiedAt = null;
                    await user.save();
                    
                } catch (error) {
                    console.error('Face update error:', error);
                    faceVerificationStatus.textContent = 'Error updating face photo: ' + error.message;
                    faceVerificationStatus.className = 'alert alert-danger';
                }
            });
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }
        
        // Helper function to format date and time
        function formatDateTime(dateString, timeString) {
            const date = new Date(dateString);
            return `${date.toLocaleDateString()} at ${timeString}`;
        }

        // Add event listener for proceeding to face verification
        document.getElementById('proceedToFaceVerification').addEventListener('click', function() {
            // Switch to face verification tab
            document.querySelector('a[data-section="face-verification"]').click();
            
            // Start the camera
            const videoElement = document.getElementById('videoElement');
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: "user"
                    } 
                })
                .then(function(stream) {
                    videoElement.srcObject = stream;
                })
                .catch(function(error) {
                    console.error("Camera error:", error);
                    alert("Error accessing camera. Please allow camera access.");
                });
            }
        });

        // Function to register face
        async function registerFace() {
            const userId = document.getElementById('voterId').value;
            if (!userId) {
                alert('Please enter a voter ID');
                return;
            }

            const image = document.getElementById('capturedImage').src;
            if (!image || image === '') {
                alert('Please capture an image first');
                return;
            }

            try {
                const response = await fetch('/api/admin/register-face', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        image: image,
                        userId: userId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to register face');
                }

                const data = await response.json();
                alert('Face registered successfully');
                
                // Clear the captured image
                document.getElementById('capturedImage').src = '';
                document.getElementById('capturedImage').style.display = 'none';
                
                // Reset the camera
                startCamera();
            } catch (error) {
                console.error('Face registration error:', error);
                alert('Error registering face: ' + error.message);
            }
        }

        // AI Assistant functionality
        function initializeAIAssistant() {
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-message');
            
            // Add welcome message
            addMessage('bot', 'Hello! I am your AI assistant. How can I help you today?');
            
            // Handle send button click
            sendButton.addEventListener('click', sendMessage);
            
            // Handle enter key press
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            function sendMessage() {
                const message = userInput.value.trim();
                if (message) {
                    // Add user message to chat
                    addMessage('user', message);
                    
                    // Clear input
                    userInput.value = '';
                    
                    // Send to backend
                    fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                        },
                        body: JSON.stringify({ message })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addMessage('bot', data.response);
                        } else {
                            addMessage('bot', 'Sorry, I encountered an error. Please try again.');
                        }
                    })
                    .catch(error => {
                        console.error('Chat error:', error);
                        addMessage('bot', 'Sorry, I encountered an error. Please try again.');
                    });
                }
            }
            
            function addMessage(sender, message) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message mb-3`;
                
                const messageContent = document.createElement('div');
                messageContent.className = sender === 'user' ? 'bg-primary text-white' : 'bg-light';
                messageContent.style.padding = '10px 15px';
                messageContent.style.borderRadius = '15px';
                messageContent.style.maxWidth = '80%';
                messageContent.style.marginLeft = sender === 'user' ? 'auto' : '0';
                messageContent.style.marginRight = sender === 'user' ? '0' : 'auto';
                
                messageContent.textContent = message;
                messageDiv.appendChild(messageContent);
                chatMessages.appendChild(messageDiv);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
    </script>
</body>
</html> 